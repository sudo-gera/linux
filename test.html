<!doctype html>
<title>Save and restore</title>

<body>
<!-- <script src="build/v86_all.js"></script> -->
<script src="build/libv86.js"></script>
<script src="test.js"></script>
<script>
"use strict";

window.onload = async function()
{

    window.____em=await create_v86();
    // window.____em = new V86Starter({
    //     "acpi": false,
    //     "autostart": true,
    //     "bios": {
    //         "url": "bios/seabios.bin",
    //         "async": false
    //     },
    //     "boot_order": 531,
    //     "cdrom": {
    //         "url": "tinycore.iso",
    //         "async": false
    //     },
    //     "disable_speaker": false,
    //     "filesystem": {},
    //     "memory_size": 134217728,
    //     // "network_relay_url": "wss://relay.widgetry.org/",
    //     // "network_relay_url": "ws://localhost:3100/",
    //     "screen_container": document.getElementById("screen_container"),
    //     "vga_bios": {
    //         "url": "bios/vgabios.bin",
    //         "async": false
    //     },
    //     "vga_memory_size": 8388608,
    // });


    document.getElementById("save_file").onclick = async function()
    {
        const new_state = await window.____em.save_state();
        var a = document.createElement("a");
        a.download = "v86state.bin";
        a.href = window.URL.createObjectURL(new Blob([new_state]));
        a.dataset.downloadurl = "application/octet-stream:" + a.download + ":" + a.href;
        a.click();

        this.blur();
    };

    document.getElementById("restore_file").onchange = function()
    {
        if(this.files.length)
        {
            var filereader = new FileReader();
            window.____em.stop();

            filereader.onload = async function(e)
            {
                await window.____em.restore_state(e.target.result);
                window.____em.run();
            };

            filereader.readAsArrayBuffer(this.files[0]);

            this.value = "";
        }

        this.blur();
    };
};
</script>

<!-- <input id="save_restore" type="button" value="Save state"> -->
<input id="save_file" type="button" value="Save state to file">
Restore from file: <input id="restore_file" type="file">
upload file to /mnt/uploads: <input id="mnt_uploads" type="file">
<input id="clear_log" type="button" value="clear log">
<hr>

<!-- A minimal structure for the ScreenAdapter defined in browser/screen.js -->
<div id="screen_container" style="display: none;">
<!-- <div id="screen_container"> -->
    <div style="white-space: pre; font: 14px monospace; line-height: 14px"></div>
    <canvas style="display: none"></canvas>
</div>

<textarea id="log" style="white-space: pre; font: 14px monospace; line-height: 14px; width: 600px; height: 300px;">

</textarea>

<textarea id="input" style="white-space: pre; font: 14px monospace; line-height: 14px; width: 600px; height: 300px;">

</textarea>

<script>

    document.getElementById("save_file").onclick = async function()
    {
        const new_state = await window.____em.save_state();
        var a = document.createElement("a");
        a.download = "v86state.bin";
        a.href = window.URL.createObjectURL(new Blob([new_state]));
        a.dataset.downloadurl = "application/octet-stream:" + a.download + ":" + a.href;
        a.click();

        this.blur();
    };

    document.getElementById("restore_file").onchange = function()
    {
        if(this.files.length)
        {
            var filereader = new FileReader();
            window.____em.stop();

            filereader.onload = async function(e)
            {
                await window.____em.restore_state(e.target.result);
                window.____em.run();
            };

            filereader.readAsArrayBuffer(this.files[0]);

            this.value = "";
        }

        this.blur();
    };

document.getElementById("mnt_uploads").onchange = async function()
{
    if(this.files.length)
    {
        // var filereader = new FileReader();
        // // window.____em.stop();

        // filereader.onload = async function(e)
        // {
        //     console.log(e);
        //     // r=
        //     // await window.____em.restore_state(e.target.result);
        //     // window.____em.run();
        // };

        // // console.log(this.files[0])
        // filereader.readAsDataURL(this.files[0]);
        // // filereader.readAsArrayBuffer(this.files[0]);

        var r=await blobToBase64(this.files[0]);

        pushb64(window.____em,r,'/mnt/uploads/'+this.files[0].name,'/mnt/tmp.txt')

        this.value = "";
    }

    document.getElementById("clear_log").onclick = async function()
    {
        document.getElementById('log').value='';
        

    };


    this.blur();
};


</script>
</body>